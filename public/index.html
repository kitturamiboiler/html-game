<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ì¸ ê²Œì„</title>

<style>
    body {
        margin: 0;
        background: linear-gradient(#2b1055, #7597de);
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: sans-serif;
    }

    #game-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    max-width: 420px;
    max-height: 820px;
    background: linear-gradient(180deg, #2c1e7a, #6c7bb1);
    border-radius: 20px;
    overflow: hidden;
    margin: 0 auto;
    }

    /* ìƒë‹¨ë°” */
    #top-bar {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0,0,0,0.45);
        padding: 8px 15px;
        border-radius: 15px;
        backdrop-filter: blur(6px);
        color: white;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.35);
        white-space: nowrap;
    }

    #top-username { color: #ffd86b; }
    #top-balance { color: #fff; }

    .balance-bump {
        animation: bump 0.25s ease;
    }

    @keyframes bump {
        0%   { transform: scale(1); }
        50%  { transform: scale(1.15); }
        100% { transform: scale(1); }
    }

    /* íŒì—… ê³µí†µ */
    .popup-screen {
        display:none;
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
        padding-top:60px;
        text-align:center;
        color:white;
    }

    .popup-card {
        width:300px;
        margin:20px auto;
        background:#fff;
        color:#000;
        border-radius:15px;
        padding:20px;
        font-size:16px;
        text-align:left;
        max-height:400px;
        overflow-y:auto;
        box-shadow:0 8px 18px rgba(0,0,0,0.4);
        animation: popupIn 0.2s ease-out;
    }

    @keyframes popupIn {
        from { opacity:0; transform:translateY(10px); }
        to   { opacity:1; transform:translateY(0); }
    }

    .popup-back-btn {
        margin-top:25px;
        padding:10px 18px;
        font-size:20px;
        border:none;
        border-radius:50%;
        background:#444;
        color:white;
        cursor:pointer;
        width:50px;
        height:50px;
    }

    /* ë¡œê·¸ì¸ */
    #login-screen {
        display:block;
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,0.75);
        backdrop-filter: blur(8px);
        color:white;
        text-align:center;
        padding-top:120px;
        font-size:18px;
    }

    #login-box {
        width:280px;
        margin:auto;
        background:#fff;
        padding:20px;
        color:#000;
        border-radius:12px;
        box-shadow:0 8px 18px rgba(0,0,0,0.5);
    }

    #login-box input {
        width:100%;
        padding:10px;
        border-radius:8px;
        border:1px solid #999;
        margin-top:10px;
        margin-bottom:10px;
        font-size:16px;
    }

    #login-box button {
        width:100%;
        padding:10px;
        border:none;
        border-radius:8px;
        background:#4caf50;
        color:white;
        cursor:pointer;
        font-size:16px;
    }

    /* ë©”ë‰´ ë²„íŠ¼ */
    .menu-btn {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: rgba(255,255,255 / 0%);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 26px;
        cursor: pointer;
        box-shadow: 0 3px 8px rgb(0 0 0);
        transition: 0.1s;
    }
    .menu-btn:active { transform: scale(0.9); }

    .left-menu, .right-menu {
        position: absolute;
        top: 120px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .left-menu { left: 10px; }
    .right-menu { right: 10px; }

    #character {
    display: none !important;
    background: none !important;
    }


    /* ì±„êµ´ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes pick-swing {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(-25deg); }
        50% { transform: rotate(0deg); }
        75% { transform: rotate(25deg); }
        100% { transform: rotate(0deg); }
    }

    .pickaxe-anim {
        animation: pick-swing 0.6s ease;
    }
    /* â›ï¸ ê³¡ê´­ì´ ìŠ¤ìœ™ì´ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•´ ë°˜ë“œì‹œ í•„ìš” */
    #mine-pickaxe {
        display: inline-block;
    }

    /* ì­íŒŸ */
    .unit-btn { padding:8px 12px; border-radius:8px; background:#fff; border:none; cursor:pointer; }
    .count-btn { padding:10px 20px; border-radius:10px; background:#333; color:white; border:none; cursor:pointer; }

    /* ì¶œì„ UI */
    .attend-week-row { display:flex; justify-content:space-between; gap:4px; margin-bottom:10px; }
    .attend-week-day {
        flex:1; height:32px; border-radius:8px; background:#f1f1f1;
        display:flex; align-items:center; justify-content:center;
        font-size:14px; color:#555;
    }
    .attend-week-day.completed { background:#ffe4f1; color:#d81b60; font-weight:bold; }
    .attend-week-day.today { border:2px solid #ff80ab; }

    .attend-month-grid {
        display:grid; grid-template-columns: repeat(7, 1fr);
        gap:4px; margin-top:10px; font-size:13px;
    }
    .attend-month-day {
        height:26px; border-radius:6px; background:#f7f7f7;
        display:flex; align-items:center; justify-content:center;
        color:#444;
    }
    .attend-month-day.checked { background:#ffe4f1; color:#d81b60; font-weight:bold; }
    .attend-month-day.today { border:2px solid #ff80ab; }

    .blink-pink { animation: blinkPink 0.7s ease-out 0s 2; }
    @keyframes blinkPink {
        0% { background:#ffe4f1; transform:scale(1); }
        50% { background:#ff9ac7; transform:scale(1.08); }
        100% { background:#ffe4f1; transform:scale(1); }
    }

    /* 380Ã—700 ëª¨ë°”ì¼ì— ë”± ë§ì¶”ê¸° - ì£¼ì‹ì°½ */
    #stock-ui {
      position: absolute;
      inset: 0;
      padding: 6px;
      background: #05070a;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #fff !important;
    }

    .stock-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px;
    }

    .stock-title {
      font-size: 14px;
    }

    .stock-price-line {
      font-size: 13px;
    }

    .stock-price {
      font-size: 18px;
      font-weight: bold;
    }

    .stock-rate {
      font-size: 12px;
    }

    .stock-tabs {
      display: flex;
      gap: 4px;
    }

    .stock-tab-btn {
      flex: 1;
      padding: 4px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
    }

    .stock-tab-btn.active {
      background: #2a3b6a;
      border-color: #6f9bff;
    }

    .stock-chart-wrap {
      flex: 1;
      min-height: 260px;
      border-radius: 8px;
      background:#101319;
      border:1px solid #333;
    }

    #stock-chart {
      width: 100%;
      height: 100%;
    }
    /* â–¼ ë©”ì¸ í™”ë©´ í•˜ë‹¨ ì •ë³´ íŒ¨ë„ */
#bottom-info-panel{
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 360px;
    padding: 8px 12px;
    border-radius: 20px;

    background: rgba(255, 240, 255, 0.20);
    backdrop-filter: blur(90px);

    box-shadow: 0 4px 16px rgba(80, 40, 120, 0.25);
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
}

.info-box {
    background: rgba(255, 255, 255, 0.25);
    border: 1px solid rgba(200, 160, 255, 0.35);
    border-radius: 12px;

    padding: 10px 6px;

    display: flex;
    flex-direction: column;
    justify-content: center;   /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
    align-items: center;       /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */

    color: #231e1e;
    font-size: 13px;
    font-weight: 700;          /* Bold ì ìš© */

    backdrop-filter: blur(6px);
}

.info-total {
    margin-top: 10px;
    background: rgba(255, 255, 255, 0.25);
    border: 1px solid rgba(200, 160, 255, 0.35);
    border-radius: 12px;
    padding: 8px 6px;

    text-align: center;
    color: black;
    font-size: 14px;        /* â†“ ê¸°ì¡´ 17px â†’ 15px */
    font-weight: 600;       /* â†“ ë„ˆë¬´ ë‘ê»ì§€ ì•Šê²Œ */
    line-height: 1.3;      /* â†“ ì¤„ ê°„ê²© ì¶•ì†Œ */

    backdrop-filter: blur(8px);
}

#stock-trade {
    position: relative;
    z-index: 9999;
}
/* ğŸ“Œ ì£¼ì‹ì°½ ë‹«ê¸° ë²„íŠ¼ (ë™ê·¸ë€ ë°˜íˆ¬ëª… ìŠ¤íƒ€ì¼) */
.stock-close-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0);
    border: none;
    color: white;
    font-size: 22px;
    cursor: pointer;

    display: flex;
    justify-content: center;
    align-items: center;

    backdrop-filter: blur(4px);

    transition: 0.15s;
}

.stock-close-btn:hover {
    background: rgba(255, 255, 255, 0.25);
}

.stock-close-btn:active {
    transform: scale(0.9);
}

#saving-1-value, #saving-2-value {
    white-space: pre-line;
}
.saving-label {
    font-size: 15px;
    font-weight: 700; 
    color: #7cf27c;
    text-align: center;
    line-height: 1.2;
}
.saving-value {
    font-size: 16px;
    font-weight: 700;
    margin-top: 2px;
}
/* ===============================
   ğŸ¾ í« ìºë¦­í„° ì˜ì—­ (UI ì ˆëŒ€ ì¹¨ë²” ì•ˆí•¨)
=============================== */
#pet-container {
    position: absolute;
    left: 70%;
    top:53%;
    transform: translate(-50%, -50%);
    width: 120px;
    height: 120px;
    z-index: 10;
}

#pet {
    width: 90px;
    height: 90px;
    background-image: url("/assets/pets/cat/animations/01.png");
    background-size: auto 90px; /* ìŠ¤í”„ë¼ì´íŠ¸ ë†’ì´ì— ë§ì¶¤ */
    background-repeat: no-repeat;

    /* ì²« ë²ˆì§¸ í”„ë ˆì„ ìœ„ì¹˜ */
    background-position: 0px 0px;
}
/* ===============================
   ğŸ›’ ë°© ìŠ¤í‚¨ ìƒì  íŒì—…
=============================== */
/* ===============================
   ğŸ›’ ë°© ìŠ¤í‚¨ ìƒì  íŒì—… (popup-screenê³¼ ë…ë¦½)
=============================== */
#room-shop {
    position: fixed;
    inset: 0;
    z-index: 9999;

    display: none;          /* ê¸°ë³¸ ìˆ¨ê¹€ */
    justify-content: center;
    align-items: flex-start;

    padding-top: 90px;

    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(6px);
}

/* ìƒë‹¨ ì œëª© */
#room-shop .popup-title {
    position: absolute;
    top: 25px;
    left: 50%;
    transform: translateX(-50%);

    padding: 10px 20px;
    background: rgba(108, 150, 98, 0.4);
    border-radius: 12px;
    font-size: 24px;
    font-weight: 900;
    color: white;
    backdrop-filter: blur(6px);
}

/* ë‹«ê¸° ë²„íŠ¼ (ìƒì  ì „ìš©) */
#room-shop .popup-back-btn {
    position: absolute;
    top: 25px;
    right: 25px;

    margin-top: 0 !important;   /* ì „ì—­ margin ë¬´íš¨í™” */

    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,0.25);
    color: white;
    font-size: 22px;
    cursor: pointer;

    display: flex;
    justify-content:center;
    align-items:center;

    backdrop-filter: blur(4px);
}

/* ìƒì  ë‚´ë¶€ ì•„ì´í…œ ì˜ì—­ */
.shop-grid {
    width: 90%;
    max-height: 70%;
    margin-top: 20px;
    padding: 10px;

    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

/* ê°œë³„ ìŠ¤í‚¨ ì•„ì´í…œ */
.shop-item {
    background: rgba(255,255,255,0.12);
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    color: white;
    backdrop-filter: blur(6px);
}

.shop-item img {
    width: 120px;
    height: 120px;
    image-rendering: pixelated;
}

.shop-item button {
    margin-top: 8px;
    width: 80%;
    padding: 6px 0;
    border: none;
    border-radius: 8px;
    background: #ffc533;
    color: black;
    font-weight: bold;
}
/* ë©”ì¸ ê²Œì„ ë°°ê²½ì— ìŠ¤í‚¨ ì ìš© */
#game-container {
    background-repeat: no-repeat !important;
    background-size: 290% auto;     /* ë°© í˜•íƒœ ìœ ì§€ */
    background-position: center -500px; 
     background-color: #594e97;   /* â† ë°© ì „ì²´ë¥¼ ìœ„ë¡œ 80px ì´ë™ */
}

.my-room-card {
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 14px;
    text-align: center;
    color: white;
    backdrop-filter: blur(6px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

.my-room-card img {
    width: 140px;
    height: 140px;
    border-radius: 10px;
    object-fit: cover;
    image-rendering: pixelated;
}

.my-room-card button {
    margin-top: 10px;
    padding: 6px 12px;
    border: none;
    border-radius: 8px;
    background: #ffc533;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
}

/* ë²„íŠ¼ ê³µí†µ ì• ë‹ˆë©”ì´ì…˜ */
button {
    transition: transform 0.12s ease, background 0.15s ease, box-shadow 0.15s ease;
    cursor: pointer;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.25);
}

button:active {
    transform: scale(0.92) translateY(2px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3) inset;
}

/* ìƒì  ì•„ì´í…œ ë²„íŠ¼ */
.shop-item button {
    padding: 10px 0;
    border-radius: 10px;
    font-size: 15px;
    font-weight: bold;
    background: linear-gradient(180deg, #ffd86b, #ffb300);
    color: #000;
    transition: 0.15s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}

.shop-item button:hover {
    background: linear-gradient(180deg, #ffe091, #ffbc2f);
    transform: translateY(-2px);
}

.shop-item button:active {
    transform: scale(0.92);
    background: linear-gradient(180deg, #e8b84f, #d89c1c);
    box-shadow: 0 3px 6px rgba(0,0,0,0.3) inset;
}

/* ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.shop-item button:disabled {
    background: #4caf50 !important;
    color: white !important;
    opacity: 1 !important;
    cursor: default;
    transform: none !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
/* ===============================
   ğŸ† í¬ë””ì›€ ë­í‚¹ íŒì—…
=============================== */
.podium-wrapper {
    width: 350px;
    margin: auto;
    text-align: center;
    padding: 20px;
}

.podium-title {
    font-size: 22px;
    margin-bottom: 15px;
    font-weight: 700;
    color:yellow;
}

/* ---- ë‹¨ìƒ ì˜ì—­ ---- */
.podium {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 16px;
    margin-bottom: 25px;
}

/* ---- ê° ë‹¨ê³„ ë°•ìŠ¤ ---- */
.podium-item {
    width: 90px;
    background: #e8f0ff;
    border-radius: 15px;
    padding-top: 10px;
    position: relative;
    box-shadow: 0 5px 0 rgba(0,0,0,0.2);
}

.podium-item .name {
    font-weight: 700;
    margin-bottom: 4px;
}

.podium-item .coin {
    font-size: 14px;
    font-weight: 600;
}

/* ---- ë°œíŒ ë†’ì´ ì°¨ì´ ---- */
.podium-item.first { height: 150px; background:#ffe89b; }
.podium-item.second { height: 120px; background:#cbe1ff; }
.podium-item.third { height: 110px; background:#ffd6ec; }

/* ë°œíŒ ìˆ«ì */
.step {
    position: absolute;
    bottom: 6px;
    width: 100%;
    font-size: 26px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 2px 3px rgba(0,0,0,0.25);
}

/* ---- 4ë“± ì´í›„ ë¦¬ìŠ¤íŠ¸ ---- */
.podium-list {
    margin-top: 10px;
    text-align: left;
}

.podium-list .item {
    display: flex;
    justify-content: space-between;
    padding: 6px 10px;
    background: #f8f8f8;
    border-radius: 10px;
    margin-bottom: 6px;
    font-size: 14px;
}
/* ===========================
   ğŸ“Œ íŒì—…ë³„ ê¸€ì ìƒ‰ìƒ ì„¤ì •
   (popup-screen ì „ì²´ì—ëŠ” color ì ˆëŒ€ ë„£ì§€ ë§ê¸°!)
=========================== */

/* ì±„êµ´ íŒì—…: ê¸€ì ë°ê²Œ ë³´ì´ë„ë¡ ê²€ì • */
#mine-screen {
    color: rgb(166, 255, 0);
}

/* ì­íŒŸ íŒì—… */
#jackpot-screen {
    color: rgb(255, 238, 0);
}

/* ì¶œì„ íŒì—… */
#attendance-screen {
    color: rgb(255, 0, 128);
}

/* ì„¤ì • íŒì—… */
#settings-screen {
    color: rgb(119, 119, 119);
}

/* ì ê¸ˆ íŒì—… */
#saving-screen,
#saving-join-screen {
    color: rgb(51, 255, 0);
}

/* ì•Œë¦¼ íŒì—… */
#notice-screen {
    color: rgb(255, 0, 0);
}

/* ë„ì›€ë§ íŒì—… */
#help-screen {
    color: rgb(255, 255, 255);
}

/* ë°© ìŠ¤í‚¨ ìƒì ì€ ì´ë¯¸ ìì²´ êµ¬ì¡°ë¼ ê¸€ììƒ‰ ì œì™¸ ê°€ëŠ¥ */

/* ğŸ“Œ í¬ë””ì›€ ë­í‚¹ íŒì—… (íŠ¹ìˆ˜: ì œëª©ì€ ë…¸ë€ìƒ‰, ë‚´ë¶€ëŠ” ê²€ì •/í°ìƒ‰ ì¡°í•©) */
#podium-ranking {
    color: rgb(255, 208, 0);
}

/* ê¸°ì¡´ ë­í‚¹ íŒì—… (ë¦¬ìŠ¤íŠ¸ í˜•íƒœ) */
#rank-screen {
    color: black;
}
</style>

</head>
<body>
<!-- ë¡œê·¸ì¸ -->
<div id="login-screen">
    <div id="login-box">
        <div style="font-size:38px; margin-bottom:10px;">ğŸ”</div>
        <h2 style="margin:0 0 10px 0; font-size:24px;">ë¡œê·¸ì¸</h2>
        <p style="margin:0 0 15px 0; font-size:15px; color:#444;">ë””ìŠ¤ì½”ë“œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input id="login-id" type="text" placeholder="ì˜ˆ: 270546023246462976" style= "width: 260px;">
        <button onclick="login()">ë¡œê·¸ì¸</button>
    </div>
</div>
<!-- ë©”ì¸ í™”ë©´ -->
<div id="game-container" style="display:none;">
    <div id="top-bar"style="top: 30px;">
        <span id="top-username">???</span>
        <span id="top-balance">ğŸ’° 0</span>
    </div>
     <!-- â–¼â–¼ ë©”ì¸ í™”ë©´ í•˜ë‹¨ ì •ë³´ íŒ¨ë„ â–¼â–¼ -->
<div id="bottom-info-panel">

    <div class="info-grid">
        <div class="info-box" id="info-stock-sell">
            ë§¤ë„<br>
            <span id="stock-sell-value">0</span>
        </div>

        <div class="info-box" id="info-saving-1">
            <span id="saving-1-value">0</span>
        </div>

        <div class="info-box" id="info-stock-buy">
            ë§¤ìˆ˜<br>
            <span id="stock-buy-value">0</span>
        </div>

        <div class="info-box" id="info-saving-2">
            <span id="saving-2-value">0</span>
        </div>
    </div>

    <div class="info-total" id="info-total">
        ì´í•©: <span id="total-value">0</span>
    </div>
</div>
<!-- â–²â–² END Panel â–²â–² -->
<!-- ğŸ¾ í« í‘œì‹œ ì˜ì—­ (ê¸°ì¡´ UI ì ˆëŒ€ ìˆ˜ì • ì•ˆ í•¨) -->
<div id="pet-container">
    <div id="pet"></div>
</div>
    <div id="character"></div>

    <div class="left-menu">
        <div class="menu-btn" onclick="openRank()">ğŸ†</div>
        <div class="menu-btn" onclick="openStock()">ğŸ“ˆ</div>
        <div class="menu-btn" onclick="openSavings()">ğŸ’°</div>
        <div class="menu-btn" onclick="openSettings()">âš™ï¸</div>
        <div class="menu-btn" onclick="openHelp()">â“</div>
    </div>

    <div class="right-menu">
        <div class="menu-btn" onclick="openJackpot()">ğŸ°</div>
        <div class="menu-btn" onclick="openMine()">â›ï¸</div>
        <div class="menu-btn" onclick="openAttendance()">ğŸŸï¸</div>
        <div class="menu-btn" onclick="openNotice()">ğŸ””</div>
        <div class="menu-btn" onclick="openRoomShop()">ğŸ›’</div>
        <div class="menu-btn" onclick="openMyRooms()">ğŸ </div>
    </div>
</div>

<!-- ğŸ“ˆ ì£¼ì‹ì°½ -->
<div id="stock-ui" style="display:none;">
  <div class="stock-top-bar">
    <div class="stock-left">
      <div id="stock-title" class="stock-title">ìƒ˜ì„±í…Œí¬ (SMSG)</div>
      <div class="stock-price-line">
        <span id="stock-price" class="stock-price">0</span>
        <span id="stock-rate" class="stock-rate">(0.00%)</span>
      </div>
      <div class="stock-sub">
        <span id="stock-sector">IT</span> |
        ê³ ê°€ <span id="stock-high">0</span> /
        ì €ê°€ <span id="stock-low">0</span> /
        ê±°ë˜ëŸ‰ <span id="stock-volume">0</span>
      </div>
    </div>
    <div class="stock-right">
      <button class="stock-close-btn" onclick="closeStock()">â†©</button>
    </div>
  </div>

  <!-- ì¢…ëª© ì„ íƒ ë²„íŠ¼ -->
  <div class="stock-tabs" id="stock-tabs"></div>

  <!-- â­â­â­ MA ì˜¨/ì˜¤í”„ ë²„íŠ¼ â­â­â­ -->
  <div id="ma-toggle"
       style="display:flex; gap:6px; margin:6px; justify-content:center;">
    <button onclick="toggleMA('ma5')" 
            style="padding:5px 10px; border-radius:6px; border:none; background:#222; color:white;">
        MA5
    </button>
    <button onclick="toggleMA('ma20')" 
            style="padding:5px 10px; border-radius:6px; border:none; background:#222; color:white;">
        MA20
    </button>
    <button onclick="toggleMA('ma60')" 
            style="padding:5px 10px; border-radius:6px; border:none; background:#222; color:white;">
        MA60
    </button>
    <button onclick="toggleMA('ma120')" 
            style="padding:5px 10px; border-radius:6px; border:none; background:#222; color:white;">
        MA120
    </button>
  </div>
  <!-- â­â­â­ END â­â­â­ -->

  <!-- ì°¨íŠ¸ ì˜ì—­ -->
  <div class="stock-chart-wrap">
    <canvas id="stock-chart"></canvas>
  </div>
</div>

<!-- ğŸ“ˆ ê±°ë˜ ë²„íŠ¼ -->
<div id="stock-trade" style="
  margin-top:8px; 
  background:#111; 
  padding:10px; 
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  gap:10px;
">
  <button onclick="openBuy()" style="
    flex:1;
    padding:10px;
    background:#2ecc71;
    border:none;
    color:white;
    font-size:14px;
    border-radius:8px;
  ">ë§¤ìˆ˜</button>

  <button onclick="openSell()" style="
    flex:1;
    padding:10px;
    background:#e74c3c;
    border:none;
    color:white;
    font-size:14px;
    border-radius:8px;
  ">ë§¤ë„</button>
</div>
<!-- ë§¤ìˆ˜/ë§¤ë„ íŒì—… -->
<div id="trade-screen" class="popup-screen">
  <h2 id="trade-title">ë§¤ìˆ˜</h2>

  <div class="popup-card" style="text-align:center;">
      <div style="font-size:15px; margin-bottom:6px;">
        ê°€ê²©: <span id="trade-price"></span>
      </div>

      <!-- â­ ì”ì•¡ í‘œì‹œ -->
      <div id="trade-balance"
           style="margin-bottom:4px; font-size:14px; font-weight:600; color:black;">
      </div>

      <!-- â­ ìµœëŒ€ ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ í‘œì‹œ (ìƒˆë¡œ ì¶”ê°€ë¨) -->
      <div id="trade-max"
           style="margin-bottom:8px; font-size:14px; font-weight:600; color:black;">
      </div>

      <input id="trade-amount"
       type="text"
       placeholder="ìˆ˜ëŸ‰ ì…ë ¥"
       style="width:260px; padding:8px; margin-bottom:10px;">

      <button onclick="submitTrade()" style="
        width:100%; padding:12px; margin-top:12px;
        background:#3498db; color:white; border:none;
        border-radius:8px; font-size:16px;">í™•ì¸</button>

      <div id="trade-error" style="color:red; margin-top:8px;"></div>
  </div>

  <button onclick="closeTrade()" class="popup-back-btn">â†©</button>
</div>

<!-- ì¶œì„ íŒì—… -->
<div id="attendance-screen" class="popup-screen">
    <h2>ğŸŸï¸ ì¶œì„</h2>
    <div class="popup-card">
        <div style="font-size:14px;">ì´ë²ˆ ì£¼ ì¶œì„</div>
        <div id="attendance-week" class="attend-week-row"></div>

        <div id="attendance-week-bonus"
            style="color:#d81b60; font-size:13px; margin-top:4px;">
        </div>

        <div style="margin-top:10px; font-size:14px;">
            <span id="attendance-month-title"></span>
        </div>

        <div id="attendance-month-grid" class="attend-month-grid"></div>

        <div id="attendance-info" style="margin-top:10px; font-size:14px;">
            ì¶œì„ì„ ì§„í–‰í•˜ì„¸ìš”.
        </div>

        <button id="attend-btn"
            onclick="doAttendance()"
            style="width:100%; padding:12px; margin-top:12px;
            background:#4caf50; border:none; border-radius:10px; color:#fff;">
            ì¶œì„í•˜ê¸° ğŸŸï¸
        </button>
    </div>

    <button onclick="closeAttendance()" class="popup-back-btn">â†©</button>
</div>

<!-- ì­íŒŸ íŒì—… -->
<div id="jackpot-screen" class="popup-screen">
    <h2>ğŸ° ì­íŒŸ</h2>

    <div id="jackpot-balance"
         style="font-size:20px; margin-bottom:10px; font-weight:bold;">ğŸ’° 0</div>

    <div id="slot-box"
         style="width:260px; margin:15px auto; background:#fff; color:#000;
         border-radius:15px; padding:20px; font-size:40px;
         display:flex; justify-content:space-around;">
        <div id="slot1">â”</div>
        <div id="slot2">â”</div>
        <div id="slot3">â”</div>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:center; gap:8px;">
        <span>ë‹¨ìœ„:</span>
        <button class="unit-btn" onclick="setUnit('A')">A</button>
        <button class="unit-btn" onclick="setUnit('B')">B</button>
        <button class="unit-btn" onclick="setUnit('C')">C</button>
        <button class="unit-btn" onclick="setUnit('D')">D</button>
        <button class="unit-btn" onclick="setUnit('')">ê¸°ë³¸</button>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
        <input id="bet" type="text" placeholder="ë² íŒ… ê¸ˆì•¡"
            style="width:160px; padding:12px; font-size:18px; border-radius:10px; border:none; text-align:center;">

        <button onclick="startSpin(1)"
            style="padding:12px 15px; font-size:18px; border:none; border-radius:10px; background:gold;">
            SPIN ğŸ°
        </button>
    </div>

    <div style="margin-top:15px;">
        <button id="btn-30" class="count-btn" onclick="startSpin(30, this)">30íšŒ</button>
    </div>

    <button onclick="closeJackpot()" class="popup-back-btn">â†©</button>
</div>

<!-- ë­í‚¹ íŒì—… -->
<div id="rank-screen" class="popup-screen">
    <h2>ğŸ† ì¹© ë­í‚¹</h2>
    <div class="popup-card">
        <div id="rank-list">ë¡œë”© ì¤‘...</div>
    </div>
    <button onclick="closeRank()" class="popup-back-btn">â†©</button>
</div>
<!-- ğŸ† í¬ë””ì›€ ë­í‚¹ íŒì—… -->
<div id="podium-ranking" class="popup-screen" style="display:none;">
    <div class="podium-wrapper">
        <div class="podium-title">ğŸ† ì¹© ë­í‚¹</div>

        <!-- 1~3ë“± ë‹¨ìƒ -->
        <div class="podium">
            <div class="podium-item second">
                <div class="name">-</div>
                <div class="coin">-</div>
            </div>

            <div class="podium-item first">
                <div class="name">-</div>
                <div class="coin">-</div>
            </div>

            <div class="podium-item third">
                <div class="name">-</div>
                <div class="coin">-</div>
            </div>
        </div>

        <!-- 4ë“± ì´í•˜ -->
        <div id="podium-list" class="podium-list"></div>

        <!-- ë‹«ê¸° ë²„íŠ¼ -->
        <button class="popup-back-btn" onclick="closePodium()">â†©</button>
    </div>
</div>

<!-- ì„¤ì • íŒì—… -->
<div id="settings-screen" class="popup-screen">
    <h2>âš™ï¸ ì„¤ì •</h2>
    <div class="popup-card">
        <h3>ğŸ‘¤ ë‹‰ë„¤ì„ ë³€ê²½</h3>
        <input id="nickname-input" type="text" maxlength="16" placeholder="ìƒˆ ë‹‰ë„¤ì„"
            style="width: 280px;padding:8px;">

        <button onclick="saveNickname()"
            style="margin-top:10px; padding:10px; width:100%;
            border:none; border-radius:8px; background:#4caf50; color:#fff;">
            ì €ì¥
        </button>
    </div>

    <button onclick="closeSettings()" class="popup-back-btn">â†©</button>
</div>

<!-- ë‚´ê°€ ê°€ì§„ ë°© íŒì—… -->
<div id="my-rooms" class="popup-screen">
    <h2>ğŸ </h2>
    <div class="popup-card" id="my-room-list"></div>
    <button onclick="closePopup('my-rooms')" class="popup-back-btn">â†©</button>
</div>

<!-- ì±„êµ´ íŒì—… -->
<div id="mine-screen" class="popup-screen">
    <h2>â›ï¸ ì±„êµ´</h2>

    <div class="popup-card" style="text-align:center;">
        <div id="mine-count" style="font-size:16px; margin-bottom:10px;">
            ì˜¤ëŠ˜ ì±„êµ´ ê°€ëŠ¥ íšŸìˆ˜: ?
        </div>

        <div style="font-size:80px; margin:10px;">
            <span id="mine-pickaxe">â›ï¸</span>
        </div>

        <div id="mine-result"
             style="font-size:20px; margin-top:10px; min-height:40px;">
        </div>

        <button id="mine-btn"
            onclick="doMine()"
            style="width:100%; padding:12px; margin-top:12px;
            background:#4caf50; border:none; border-radius:10px; color:#fff;
            font-size:18px; cursor:pointer;">
            ì±„êµ´í•˜ê¸° â›ï¸
        </button>
    </div>

    <button onclick="closePopup('mine-screen')" class="popup-back-btn">â†©</button>
</div>

<!-- ì•Œë¦¼ íŒì—… -->
<div id="notice-screen" class="popup-screen">
    <h2>ğŸ”” ì•Œë¦¼</h2>
    <div class="popup-card">ì¶”í›„ ì—…ë°ì´íŠ¸</div>
    <button onclick="closeNotice()" class="popup-back-btn">â†©</button>
</div>

<!-- ë„ì›€ë§ íŒì—… -->
<div id="help-screen" class="popup-screen">
    <h2>â“ ë„ì›€ë§</h2>

    <div class="popup-card">
        <p style="font-size:15px; line-height:1.5;">
            ë„ì›€ë§ì€ ì¶”í›„ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤!<br>
            ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë”ë¼ë„! ì˜¤ì§€ ë§ì•„ì£¼ì„¸ìš”. ğŸ˜Š
        </p>
    </div>

    <button onclick="closePopup('help-screen')" class="popup-back-btn">â†©</button>
</div>

<!-- ğŸ›’ ë°© ìŠ¤í‚¨ ìƒì  íŒì—… -->
<div id="room-shop" style="display:none;">
    <div class="popup-title">ğŸ  ë°© ìŠ¤í‚¨ ìƒì </div>

    <div id="room-shop-items" class="shop-grid">
        <!-- JSì—ì„œ ìë™ ìƒì„± -->
    </div>

    <button class="popup-back-btn" onclick="closePopup('room-shop')">â†©</button>
</div>

<!-- â­â­â­ ì €ì¶•(ì ê¸ˆ) íŒì—… â­â­â­ -->
<div id="saving-screen" class="popup-screen">
    <h2>ğŸ’° ì €ì¶• / ì ê¸ˆ</h2>

    <div class="popup-card" style="text-align:center;">

        <div id="saving-balance"
             style="margin-bottom:12px; font-size:17px; font-weight:bold; color:#444;"></div>

        <div id="saving-active-list"
             style="font-size:14px; text-align:left; margin-bottom:15px;">
            ë¡œë”©ì¤‘...
        </div>

        <h3 style="font-size:16px; margin-top:10px;">ğŸ“¦ ìƒí’ˆ ì„ íƒ</h3>

        <button onclick="openSavingJoin('soso')"
            style="width:100%; padding:10px; margin-top:8px; border:none;
            background:#ffd54f; border-radius:8px; cursor:pointer; font-size:16px;">
            ğŸ“¦ ì†Œì†Œí•˜ê²Œ ë²Œì
        </button>

        <button onclick="openSavingJoin('hanbang')"
            style="width:100%; padding:10px; margin-top:8px; border:none;
            background:#ff8a80; border-radius:8px; cursor:pointer; font-size:16px;">
            ğŸ’¥ ì—­ì‹œ ì¸ìƒì€ í•œë°©
        </button>

    </div>

    <button onclick="closeSavings()" class="popup-back-btn">â†©</button>
</div>

<!-- â­â­â­ ì ê¸ˆ ê°€ì… í™”ë©´ â­â­â­ -->
<div id="saving-join-screen" class="popup-screen">
    <h2>ğŸ’° ì ê¸ˆ ê°€ì…</h2>
    <div class="popup-card" style="text-align:center;">

        <div id="saving-join-desc"
             style="font-size:14px; margin-bottom:10px;"></div>

        <input id="saving-amount" type="text"
            placeholder="ì ê¸ˆ ê¸ˆì•¡ ì…ë ¥"
            style="width: 276px;padding:10px;border-radius:8px;border:1px solid #888;text-align:center;font-size:18px;">

        <button onclick="submitSavingJoin()"
            style="width:100%; margin-top:12px; padding:12px;
            background:#4caf50; color:white; border:none; border-radius:10px;
            font-size:18px; cursor:pointer;">
            ê°€ì…í•˜ê¸°
        </button>

        <div id="saving-join-error" style="color:red; margin-top:8px;"></div>

    </div>

    <button onclick="closeSavingJoin()" class="popup-back-btn">â†©</button>
</div>
<script>
let USER_ID = null;
let USER_NAME = null;
let selectedUnit = "";
let savingJoinProduct = null;
let TRADE_MODE = null; // "BUY" or "SELL"

/* ===============================
    ê³µí†µ íŒì—…
=============================== */
function openPopup(id) { document.getElementById(id).style.display = "block"; hidePet(); }
function closePopup(id) { document.getElementById(id).style.display = "none"; showPet(); }

/* ===============================
    ë¡œê·¸ì¸
=============================== */
async function login() {
    const id = document.getElementById("login-id").value.trim();
    if (!id) return alert("ë””ìŠ¤ì½”ë“œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    const r = await fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ discordId: id })
    });

    const data = await r.json();

    if (data.error) return alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + data.error);

    // ğŸ”¥ ë¡œê·¸ì¸ ì„±ê³µ â†’ ì´ì œ USER_ID ì„¤ì •í•´ì•¼ í•¨
    USER_ID = id;
    USER_NAME = data.name;

    // ğŸ”¥ ë°© ìŠ¤í‚¨ ë° ì†Œìœ  ìŠ¤í‚¨ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    await loadRoomData();  // â† ì—¬ê¸°ë¡œ ì´ë™í•´ì•¼ ì •ìƒ!

    // UI í‘œì‹œ
    document.getElementById("top-username").textContent = USER_NAME;
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("game-container").style.display = "block";

    refreshBalance();
}
/* ===============================
    ì”ì•¡ ê°±ì‹ 
=============================== */
async function refreshBalance() {
    if (!USER_ID) return;

    const r = await fetch(`/api/balance?id=${USER_ID}`);
    const data = await r.json();

    const el = document.getElementById("top-balance");
    el.textContent = "ğŸ’° " + data.formatted;

    el.classList.remove("balance-bump");
    void el.offsetWidth;
    el.classList.add("balance-bump");
}

/* ===============================
    ì ê¸ˆ íŒì—… ì—´ê¸°
=============================== */
async function openSavings() {
    if (!USER_ID) return;

    const r = await fetch(`/api/saving/info?id=${USER_ID}`);
    const data = await r.json();

    document.getElementById("saving-balance").textContent =
        `í˜„ì¬ ì”ì•¡: ğŸ’° ${data.formatted}`;

    let html = "";

    if (data.active.length === 0) {
        html = `<div style="color:#777;">ì§„í–‰ ì¤‘ì¸ ì ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
        html += `<div style="font-size:15px; font-weight:bold;">ğŸ“Œ ì§„í–‰ì¤‘ì¸ ì ê¸ˆ</div>`;
        data.active.forEach(s => {
            html += `
                <div style="margin-top:8px; border-bottom:1px solid #ddd; padding-bottom:6px;">
                    <b>${s.product === "soso" ? "ğŸ“¦ ì†Œì†Œí•˜ê²Œ" : "ğŸ’¥ í•œë°©"}</b><br>
                    ì›ê¸ˆ: ${formatToUnit(s.amount)}<br>
                    ì´ìœ¨/ë°°ìˆ˜: ${s.rate}${s.product === "soso" ? "%" : "ë°°"}<br>
                    ì„¸ê¸ˆ: ${s.tax}%<br>
                    ë‚¨ì€ ì¼ìˆ˜: ${s.remainDays}ì¼
                </div>
            `;
        });
    }

    document.getElementById("saving-active-list").innerHTML = html;

    openPopup("saving-screen");
}

function closeSavings() { closePopup("saving-screen"); }

/* ===============================
    ì ê¸ˆ ê°€ì… í™”ë©´ ì—´ê¸°
=============================== */
function openSavingJoin(type) {
    savingJoinProduct = type;

    if (type === "soso") {
        document.getElementById("saving-join-desc").innerHTML = `
            <b>ğŸ“¦ ì†Œì†Œí•˜ê²Œ ë²Œì</b><br>
            ê¸°ê°„: 1~10ì¼<br>
            ì´ìœ¨: 10~50%<br>
            ì„¸ê¸ˆ: ì—†ìŒ
        `;
    } else {
        document.getElementById("saving-join-desc").innerHTML = `
            <b>ğŸ’¥ ì—­ì‹œ ì¸ìƒì€ í•œë°©</b><br>
            ê¸°ê°„: 1~100ì¼<br>
            ì´ìœ¨: 0~100ë°°<br>
            ì„¸ê¸ˆ: 0~50%
        `;
    }

    document.getElementById("saving-join-error").textContent = "";
    document.getElementById("saving-amount").value = "";

    openPopup("saving-join-screen");
}

function closeSavingJoin() { closePopup("saving-join-screen"); }

/* ===============================
    ì ê¸ˆ ê°€ì… API
=============================== */
async function submitSavingJoin() {
    const raw = document.getElementById("saving-amount").value.trim();
    const amount = parseAmount(raw);   // ë‹¨ìœ„ ë³€í™˜
    const errBox = document.getElementById("saving-join-error"); // â† ë°˜ë“œì‹œ ìˆì–´ì•¼ í•¨

    errBox.textContent = "";

    if (!amount || amount <= 0) {
        errBox.textContent = "ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.";
        return;
    }

    const r = await fetch("/api/saving/join", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            id: USER_ID,
            product: savingJoinProduct,
            amount: amount
        })
    });

    const data = await r.json();

    if (data.error) {
        errBox.textContent = data.error;
        return;
    }

    closeSavingJoin();
    openSavings();
    refreshBalance();
}

/* ===============================
    ì¶œì„
=============================== */
function openAttendance() {
    fetchAttendanceInfo();
    openPopup("attendance-screen");
}

function closeAttendance() {
    closePopup("attendance-screen");
}

function loadAttendanceView(att = null) {
    const weekRow = document.getElementById("attendance-week");
    const monthGrid = document.getElementById("attendance-month-grid");
    const info = document.getElementById("attendance-info");
    const btn = document.getElementById("attend-btn");

    const today = new Date();
    const y = today.getFullYear();
    const m = today.getMonth() + 1;
    const d = today.getDate();

    document.getElementById("attendance-month-title").textContent =
        `${y}ë…„ ${m}ì›” ì¶œì„`;

    weekRow.innerHTML = "";
    const streak = att?.streak || 0;
    const weekIndex = att?.weekIndex || 0;
    const just = att?.justCheckedToday;

    for (let i = 1; i <= 7; i++) {
        const div = document.createElement("div");
        div.className = "attend-week-day";
        div.textContent = i;

        if (streak && i <= (streak % 7 || 7)) div.classList.add("completed");

        if (i === weekIndex) {
            div.classList.add(just ? "blink-pink" : "today");
        }
        weekRow.appendChild(div);
    }

    monthGrid.innerHTML = "";
    const firstDay = new Date(y, m - 1, 1).getDay();
    const lastDate = new Date(y, m, 0).getDate();

    for (let i = 0; i < firstDay; i++) monthGrid.appendChild(document.createElement("div"));

    const attended = att?.attendedDays || [];

    for (let day = 1; day <= lastDate; day++) {
        const div = document.createElement("div");
        div.className = "attend-month-day";
        div.textContent = day;

        if (attended.includes(day)) div.classList.add("checked");
        if (day === d) div.classList.add(just ? "blink-pink" : "today");

        monthGrid.appendChild(div);
    }

    if (att?.error || att?.alreadyToday) {
        info.innerHTML = `<span style="color:red;">ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í–ˆìŠµë‹ˆë‹¤</span>`;
        btn.style.display = "none";
    } else if (att) {
        info.innerHTML =
            `ğŸ‰ ${att.streak}ì¼ì°¨ ì¶œì„ ì™„ë£Œ!<br>` +
            `ê¸°ë³¸ë³´ìƒ +${att.reward.toLocaleString()} ğŸª™` +
            (att.weeklyBonus ? `<br>ğŸ ì£¼ê°„ë³´ìƒ +${att.weeklyBonus}` : "") +
            (att.monthlyBonus ? `<br>ğŸŒ• ì›”ê°„ë³´ìƒ +${att.monthlyBonus}` : "");

        btn.style.display = "none";
    } else {
        btn.style.display = "block";
        btn.disabled = false;
    }
}

async function fetchAttendanceInfo() {
    const r = await fetch(`/api/attendance/info?id=${USER_ID}`);
    const data = await r.json();

    loadAttendanceView({
        streak: data.streak,
        weekIndex: data.weekIndex,
        attendedDays: data.attendedDays,
        justCheckedToday: data.alreadyToday,
        alreadyToday: data.alreadyToday
    });
}

async function doAttendance() {
    const r = await fetch("/api/attendance", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id: USER_ID })
    });

    const data = await r.json();
    if (data.error) return fetchAttendanceInfo();

    loadAttendanceView({
        streak: data.streak,
        reward: data.reward,
        weeklyBonus: data.weeklyBonus,
        monthlyBonus: data.monthlyBonus,
        weekIndex: data.weekIndex,
        attendedDays: data.attendedDays,
        justCheckedToday: true
    });

    refreshBalance();
}

/* ===============================
    ì±„êµ´
=============================== */
async function openMine() {
    hidePet();
    if (!USER_ID) {
        alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
        return;
    }

    const r = await fetch(`/api/mine/info?id=${USER_ID}`);
    const data = await r.json();

    if (data.error) {
        alert("ì±„êµ´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        return;
    }

    document.getElementById("mine-count").textContent =
        `ì˜¤ëŠ˜ ì±„êµ´ ê°€ëŠ¥ íšŸìˆ˜: ${data.left}íšŒ`;

    document.getElementById("mine-result").textContent = "";

    openPopup("mine-screen");
}

async function doMine() {
    if (!USER_ID) {
        alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
        return;
    }

    const btn = document.getElementById("mine-btn");
    const pick = document.getElementById("mine-pickaxe");
    const resultBox = document.getElementById("mine-result");

    btn.disabled = true;
    pick.classList.remove("pickaxe-anim");
    void pick.offsetWidth;
    pick.classList.add("pickaxe-anim");

    await new Promise(r => setTimeout(r, 600));

    const r = await fetch("/api/mine", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: USER_ID })
    });

    const data = await r.json();

    if (data.error === "ë¡œê·¸ì¸ í•„ìš”") {
        alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        btn.disabled = false;
        return;
    }

    if (data.error === "LIMIT") {
        resultBox.textContent = "â›ï¸ ì˜¤ëŠ˜ ì±„êµ´ì€ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.";
        resultBox.style.color = "red";
        btn.disabled = false;
        return;
    }

    resultBox.style.color = "#d81b60";
    resultBox.innerHTML = `â›ï¸ ì±„êµ´ ì„±ê³µ!<br>+${data.reward} A`;

    refreshBalance();

    document.getElementById("mine-count").textContent =
        `ì˜¤ëŠ˜ ì±„êµ´ ê°€ëŠ¥ íšŸìˆ˜: ${data.left}íšŒ`;

    btn.disabled = false;
}

/* ===============================
    ì­íŒŸ
=============================== */
function openJackpot() {
    updateJackpotBalance();
    openPopup("jackpot-screen");
}

function closeJackpot() { closePopup("jackpot-screen"); }

function setUnit(u) {
    selectedUnit = u;
    document.getElementById("bet").placeholder = u
        ? `ë² íŒ… ê¸ˆì•¡ (${u})` : "ë² íŒ… ê¸ˆì•¡";
}

async function updateJackpotBalance() {
    const r = await fetch(`/api/balance?id=${USER_ID}`);
    const data = await r.json();
    document.getElementById("jackpot-balance").textContent = "ğŸ’° " + data.formatted;
}

// function parseAmount(text) {
//     text = text.trim().toUpperCase();
//     if (!isNaN(Number(text))) return Number(text);

//     const m = text.match(/^([0-9\.]+)\s*([A-Z])(\'*)$/);
//     if (!m) return NaN;

//     let num = parseFloat(m[1]);
//     let unit = m[2];
//     let tier = m[3].length;
//     let base = unit.charCodeAt(0) - 65;
//     let exp = (base + 1) + tier * 26;

//     return num * (1000 ** exp);
// }

async function spinJackpot() {
    const betInput = document.getElementById("bet");
    let raw = betInput.value;
    if (selectedUnit) raw += selectedUnit;

    const bet = parseAmount(raw);
    if (!bet || bet <= 0) return true;

    document.getElementById("slot1").textContent = "ğŸ²";
    document.getElementById("slot2").textContent = "ğŸ²";
    document.getElementById("slot3").textContent = "ğŸ²";

    const r = await fetch("/api/jackpot", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id: USER_ID, bet })
    });

    const data = await r.json();

    if (data.error) return true;

    document.getElementById("slot1").textContent = data.result[0];
    document.getElementById("slot2").textContent = data.result[1];
    document.getElementById("slot3").textContent = data.result[2];

    refreshBalance();
    updateJackpotBalance();

    return false;
}

async function startSpin(count) {
    for (let i = 0; i < count; i++) {
        const stop = await spinJackpot();
        if (stop) break;
        await new Promise(r => setTimeout(r, 30));
    }
}

/* ===============================
    ë­í‚¹
=============================== */
async function openRank() {
    const res = await fetch("/api/rank");
    const data = await res.json();

    // data.ranking ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const ranking = data.ranking.map(u => ({
        id: u.id,
        name: u.name,
        total: u.balance
    }));

    renderPodiumRanking(ranking);

    document.getElementById("podium-ranking").style.display = "block";
    hidePet();
}

function closeRank() { closePopup("rank-screen"); }
/* ===============================
    ì„¤ì •
=============================== */
function openSettings() {
    document.getElementById("nickname-input").value = USER_NAME;
    openPopup("settings-screen");
}

async function saveNickname() {
    const name = document.getElementById("nickname-input").value.trim();
    if (!name) return;

    await fetch("/api/setname", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ id: USER_ID, name })
    });

    USER_NAME = name;
    document.getElementById("top-username").textContent = name;

    closeSettings();
}

function closeSettings() { closePopup("settings-screen"); }

/* ===============================
    ê¸°íƒ€ ë©”ë‰´
=============================== */
function openHelp() { openPopup('help-screen'); }
function openNotice() { openPopup("notice-screen"); }
function closeNotice() { closePopup("notice-screen"); }

/* ===============================
   ğŸ“ˆ ì£¼ì‹ ì‹œìŠ¤í…œ â€“ ì¢…ëª© ì •ì˜
=============================== */
const STOCK_DEFS = {
    SMSG: { code:"SMSG", name:"ìƒ˜ì„±í…Œí¬", sector:"IT", basePrice:72000, volatility:0.9,  trend:0.01  },
    LGBM: { code:"LGBM", name:"ì—˜ì§€ë°°í„°ë¦¬", sector:"ë°°í„°ë¦¬", basePrice:52000, volatility:1.2,  trend:0.015 },
    DGPH: { code:"DGPH", name:"ë™ê°•ì œì•½",   sector:"ì œì•½",   basePrice:31000, volatility:1.4,  trend:-0.005 },
    HYDM: { code:"HYDM", name:"í˜„ë‹¤ëª¨í„°ìŠ¤", sector:"ìë™ì°¨", basePrice:65000, volatility:0.7,  trend:0.008 }
};

const marketState = {};
let selectedSymbol = "SMSG";

const TICK_MS = 900;
const CANDLE_TICKS = 5;
const MAX_CANDLES = 60;

let stockChartCanvas = null;
let stockChartCtx = null;

/* ===============================
   ğŸ“Œ ì‹œì„¸ ì´ˆê¸°í™”
=============================== */
function initMarket() {
    Object.values(STOCK_DEFS).forEach(def => {
        const start = def.basePrice * (0.95 + Math.random() * 0.1);

        marketState[def.code] = {
            code: def.code,
            name: def.name,
            sector: def.sector,
            price: start,
            openToday: start,
            highToday: start,
            lowToday: start,
            volumeToday: 0,
            candles: [],
            currentCandle: {
                open: start,
                high: start,
                low:  start,
                close: start,
                volume: 0
            },
            tickInCandle: 0
        };
    });
}

/* ===============================
   ğŸ“ˆ ì‹œì„¸ ê°±ì‹  (ì¶”ì„¸ + ë³€ë™ì„±)
=============================== */
function tickMarket() {
    Object.values(STOCK_DEFS).forEach(def => {
        const st = marketState[def.code];
        const before = st.price;

        const rnd = (Math.random() * 2 - 1);
        const changeRate = def.trend * 0.01 + rnd * def.volatility * 0.005;

        let next = before * (1 + changeRate);
        if (next < def.basePrice * 0.3) next = def.basePrice * 0.3;
        if (next > def.basePrice * 3.0) next = def.basePrice * 3.0;

        st.price = next;
        st.highToday = Math.max(st.highToday, next);
        st.lowToday  = Math.min(st.lowToday, next);

        const vol = Math.floor(Math.abs(changeRate) * 3000 + Math.random() * 200);
        st.volumeToday += vol;

        const c = st.currentCandle;
        c.high   = Math.max(c.high, next);
        c.low    = Math.min(c.low, next);
        c.close  = next;
        c.volume += vol;

        st.tickInCandle++;

        if (st.tickInCandle >= CANDLE_TICKS) {
            st.candles.push({ ...st.currentCandle });

            if (st.candles.length > MAX_CANDLES) st.candles.shift();

            st.currentCandle = {
                open: next,
                high: next,
                low:  next,
                close: next,
                volume: 0
            };
            st.tickInCandle = 0;
        }
    });

    const stockUI = document.getElementById("stock-ui");
    if (stockUI && stockUI.style.display !== "none") {
        updateStockUI();
        drawCandles();
    }
}

/* ===============================
   ğŸ“Œ openStock() â€“ UI ì—´ê¸°
=============================== */
function openStock() {
    hidePet();
    const ui = document.getElementById("stock-ui");
    ui.style.display = "flex";

    if (!stockChartCanvas) {
        stockChartCanvas = document.getElementById("stock-chart");
        stockChartCtx = stockChartCanvas.getContext("2d");

        const resize = () => {
            stockChartCanvas.width = stockChartCanvas.clientWidth;
            stockChartCanvas.height = stockChartCanvas.clientHeight;
            drawCandles();
        };
        resize();
        window.addEventListener("resize", resize);
    }

    buildStockTabs();
    updateStockUI();
    drawCandles();
}

/* ===============================
   ğŸ“Œ ì¢…ëª© íƒ­ ìƒì„±
=============================== */
function buildStockTabs() {
    const wrap = document.getElementById("stock-tabs");
    wrap.innerHTML = "";

    Object.values(STOCK_DEFS).forEach(def => {
        const btn = document.createElement("button");
        btn.className = "stock-tab-btn" + (def.code === selectedSymbol ? " active" : "");
        btn.textContent = `${def.name} (${def.code})`;
        btn.onclick = () => {
            selectedSymbol = def.code;
            buildStockTabs();
            updateStockUI();
            drawCandles();
        };
        wrap.appendChild(btn);
    });
}

/* ===============================
   ğŸ“Œ ì£¼ì‹ ì •ë³´ UI ì—…ë°ì´íŠ¸
=============================== */
function updateStockUI() {
    const st = marketState[selectedSymbol];
    const def = STOCK_DEFS[selectedSymbol];
    if (!st) return;

    const rate = ((st.price - def.basePrice) / def.basePrice) * 100;

    document.getElementById("stock-title").textContent =
        `${st.name} (${st.code})`;

    document.getElementById("stock-price").textContent =
        st.price.toFixed(2);

    const rateEl = document.getElementById("stock-rate");
    rateEl.textContent = `(${rate >= 0 ? "+" : ""}${rate.toFixed(2)}%)`;
    rateEl.style.color = rate >= 0 ? "#ff4444" : "#44aaff";

    document.getElementById("stock-sector").textContent = st.sector;
    document.getElementById("stock-high").textContent = st.highToday.toFixed(2);
    document.getElementById("stock-low").textContent = st.lowToday.toFixed(2);
    document.getElementById("stock-volume").textContent =
        st.volumeToday.toLocaleString();
}

/* ===============================
   ğŸ“ˆ ìº”ë“¤ ì°¨íŠ¸ ê·¸ë¦¬ê¸° + ì´ë™í‰ê· ì„  ì¶”ê°€
=============================== */
function drawCandles() {
    if (!stockChartCtx || !stockChartCanvas) return;

    const st = marketState[selectedSymbol];
    if (!st) return;

    const ctx = stockChartCtx;
    const w = stockChartCanvas.width;
    const h = stockChartCanvas.height;

    ctx.clearRect(0, 0, w, h);

    const candles = [...st.candles, st.currentCandle];
    if (candles.length === 0) return;

    // === ê°€ê²© ë²”ìœ„ ê³„ì‚° ===
    let minP = Infinity;
    let maxP = -Infinity;

    candles.forEach(c => {
        minP = Math.min(minP, c.low);
        maxP = Math.max(maxP, c.high);
    });

    if (minP === maxP) {
        minP *= 0.95;
        maxP *= 1.05;
    }

    // === ë³´ì¡°ì„  ===
    ctx.strokeStyle = "rgba(255,255,255,0.05)";
    ctx.lineWidth = 1;

    const rows = 4;
    for (let i = 1; i < rows; i++) {
        const y = (h / rows) * i;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
    }

    // === ìº”ë“¤ í¬ê¸° ===
    const count = candles.length;
    const candleWidth = Math.max(4, (w / count) * 0.6);
    const gap = (w - candleWidth * count) / (count + 1);

    const priceToY = (p) =>
        h - ((p - minP) / (maxP - minP)) * (h * 0.9) - h * 0.05;

    // === ìº”ë“¤ ê·¸ë¦¬ê¸° ===
    candles.forEach((c, i) => {
        const xCenter = gap + i * (candleWidth + gap) + candleWidth / 2;

        const yHigh = priceToY(c.high);
        const yLow  = priceToY(c.low);
        const yOpen = priceToY(c.open);
        const yClose = priceToY(c.close);

        const isUp = c.close >= c.open;
        const color = isUp ? "#ff4444" : "#44aaff";

        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(xCenter, yHigh);
        ctx.lineTo(xCenter, yLow);
        ctx.stroke();

        const top = Math.min(yOpen, yClose);
        const bottom = Math.max(yOpen, yClose);
        const bodyH = Math.max(2, bottom - top);

        ctx.fillStyle = color;
        ctx.fillRect(xCenter - candleWidth / 2, top, candleWidth, bodyH);
    });

    // ===== ì´ë™í‰ê· ì„  =====
    const arr = candles;

    const ma5   = calcMA(arr, 5);
    const ma20  = calcMA(arr, 20);
    const ma60  = calcMA(arr, 60);
    const ma120 = calcMA(arr, 120);

    const drawMA = (data, color, offset = 0) => {
        if (!data.length) return;

        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;

        const gapX = w / arr.length;

        data.forEach((price, i) => {
            const x = i * gapX + gapX / 2 + offset;
            const y = priceToY(price);

            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });

        ctx.stroke();
    };

    // ğŸ”¥ ì˜¨/ì˜¤í”„ ìƒíƒœì— ë”°ë¼ ê·¸ë¦¬ê¸°
    if (MA_VISIBLE.ma5)   drawMA(ma5,   "rgba(0,255,0,0.7)", 0); // ì´ˆ
    if (MA_VISIBLE.ma20)  drawMA(ma20,  "rgba(255,80,80,0.7)", 1); // ë¹¨
    if (MA_VISIBLE.ma60)  drawMA(ma60,  "rgba(255,255,100,0.7)", 2); // ë…¸
    if (MA_VISIBLE.ma120) drawMA(ma120, "rgba(100,160,255,0.7)", 3); // ë³´
}
/* ===============================
   ğŸ“Œ ì´ë™í‰ê· ì„  ON/OFF ì„¤ì •
=============================== */
const MA_VISIBLE = {
    ma5: true,
    ma20: true,
    ma60: true,
    ma120: true
};

function toggleMA(type) {
    MA_VISIBLE[type] = !MA_VISIBLE[type];

    const btn = document.querySelector(`#ma-toggle button[onclick*="${type}"]`);
    if (btn) {
        btn.style.background = MA_VISIBLE[type] ? "#3b3b3b" : "#222";
        btn.style.color = MA_VISIBLE[type] ? "#fff" : "#777";
    }

    drawCandles();
}
/* ===============================
   ğŸ“Œ ì´ë™í‰ê· ì„ (MA) ê·¸ë¦¬ê¸°
=============================== */
function drawMAline(maData, color, offset) {
    const ctx = stockChartCtx;
    const w = stockChartCanvas.width;
    const h = stockChartCanvas.height;

    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();

    const gap = (w / maData.length);

    maData.forEach((price, i) => {
        const candles = marketState[selectedSymbol].candles;
        const allData = [...candles, marketState[selectedSymbol].currentCandle];

        const minP = Math.min(...allData.map(c => c.low));
        const maxP = Math.max(...allData.map(c => c.high));
        const y = h - ((price - minP) / (maxP - minP)) * (h * 0.9) - h * 0.05;

        const x = i * gap + gap / 2 + offset;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.stroke();
}

/* ===============================
   ğŸ“Œ ë‹«ê¸° ë²„íŠ¼ (ğŸ“ˆì°½)
=============================== */
function closeStock() {
    document.getElementById("stock-ui").style.display = "none";
    showPet();
}

/* ===============================
   ğŸ“Œ ë§¤ìˆ˜/ë§¤ë„ ë¡œì§
=============================== */
async function openBuy() {
    TRADE_MODE = "BUY";
    const st = marketState[selectedSymbol];

    document.getElementById("trade-title").textContent = "ë§¤ìˆ˜ (BUY)";
    document.getElementById("trade-price").textContent = st.price.toFixed(2);
    document.getElementById("trade-error").textContent = "";

    // ğŸ”¥ ì”ì•¡ ë¶ˆëŸ¬ì˜¤ê¸°
    const r = await fetch(`/api/balance?id=${USER_ID}`);
    const data = await r.json();
    const balance = data.balance || 0;

    // ì”ì•¡ í‘œì‹œ
    document.getElementById("trade-balance").textContent =
        `ì”ì•¡: ${formatToUnit(balance)}`;

    // ğŸ”¥ ìµœëŒ€ ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚°
    const maxAmount = balance / st.price;

    document.getElementById("trade-max").textContent =
        `ìµœëŒ€ ë§¤ìˆ˜ ê°€ëŠ¥: ${formatToUnit(maxAmount)}`;

    openPopup("trade-screen");
}

function openSell() {
    TRADE_MODE = "SELL";
    const st = marketState[selectedSymbol];
    document.getElementById("trade-title").textContent = "ë§¤ë„ (SELL)";
    document.getElementById("trade-price").textContent = st.price.toFixed(2);
    document.getElementById("trade-error").textContent = "";
    updateTradeBalance(); // â­ ì”ì•¡ í‘œì‹œ
    openPopup("trade-screen");
}

function closeTrade() {
    closePopup("trade-screen");
}
async function submitTrade() {
    const raw = document.getElementById("trade-amount").value.trim();
    const amount = parseAmount(raw);
    const errorBox = document.getElementById("trade-error");
    errorBox.textContent = "";

    // ğŸ”¥ ë‹¨ìœ„ í¬í•¨ ì…ë ¥ í—ˆìš© ì²´í¬
    if (!amount || isNaN(amount) || amount <= 0) {
        errorBox.textContent = "ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: 1A, 2B";
        return;
    }

    if (!USER_ID) {
        errorBox.textContent = "ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.";
        return;
    }

    const symbol = selectedSymbol;
    const price = marketState[symbol].price;

    const payload = { id: USER_ID, symbol, amount, price };
    let url = "/api/stock/buy";
    if (TRADE_MODE === "SELL") url = "/api/stock/sell";

    const r = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });

    const data = await r.json();

    if (data.error) {
        errorBox.textContent = data.error;
        return;
    }

    refreshBalance();
    closeTrade();
}

/* ===============================
   ğŸ“Œ ì£¼ì‹ ì‹œìŠ¤í…œ ì´ˆê¸° ì‹¤í–‰ + ê±°ë˜ì°½ ìœ„ì¹˜ íŒ¨ì¹˜
=============================== */

// DOM ë¡œë“œ í›„ stock-tradeë¥¼ stock-ui ì•ˆìœ¼ë¡œ ì´ë™ (UIëŠ” ê·¸ëŒ€ë¡œ, êµ¬ì¡°ë§Œ ì •ë¦¬)
window.addEventListener("DOMContentLoaded", () => {
    const trade = document.getElementById("stock-trade");
    const stockUI = document.getElementById("stock-ui");
    if (trade && stockUI && trade.parentElement !== stockUI) {
        stockUI.appendChild(trade);
    }
});

initMarket();
setInterval(tickMarket, TICK_MS);

async function updateBottomPanel() {
    if (!USER_ID) return;

    // 1) ì”ì•¡
    const balRes = await fetch(`/api/balance?id=${USER_ID}`);
    const balData = await balRes.json();
    const balance = balData.balance || 0;

    // 2) ì ê¸ˆ ì •ë³´
    const savRes = await fetch(`/api/saving/info?id=${USER_ID}`);
    const savData = await savRes.json();

    const saving1Data = savData.active[0] || null;
    const saving2Data = savData.active[1] || null;

    // ì ê¸ˆ ìˆ˜ìµ ê³„ì‚°
    const s1 = calcSavingProfit(saving1Data);
    const s2 = calcSavingProfit(saving2Data);

    // 3) ë³´ìœ  ì£¼ì‹ í‰ê°€ê¸ˆ
    const stockRes = await fetch("/api/stocks");
    const stockData = await stockRes.json();

    let totalStockValue = 0;

    if (stockData[USER_ID]) {
        for (const symbol in stockData[USER_ID]) {
            const st = stockData[USER_ID][symbol];
            const amount = Number(st.amount);
            const price = marketState[symbol]?.price || 0;

            totalStockValue += amount * price;
        }
    }

    // 4) ì ê¸ˆ ë°•ìŠ¤ì— í‘œì‹œí•  í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
    function labelText(data, info) {
        if (!data) return "ì—†ìŒ";

        const name = data.product === "soso" ? "ì†Œì†Œí•˜ê²Œ" : "í•œë°©";
        const profit = formatToUnit(info.profit);
        const rate = info.rate.toFixed(2);

        return `${name}\n${profit} (${rate}%)`;
    }

    // 5) ìƒ‰ìƒ ì ìš© í•¨ìˆ˜
    function colorize(element, rate) {
        if (rate > 0) element.style.color = "#4CAF50"; // ì´ˆë¡(+)
        else if (rate < 0) element.style.color = "#FF5252"; // ë¹¨ê°•(-)
        else element.style.color = "#ffffff"; // ê¸°ë³¸ í•˜ì–‘
    }

    // ìŠ¤íƒ€ì¼ ì„¤ì • (ì¤„ ë°”ê¿ˆ í—ˆìš©)
    const el1 = document.getElementById("saving-1-value");
    const el2 = document.getElementById("saving-2-value");
    el1.style.whiteSpace = "pre-line";
    el2.style.whiteSpace = "pre-line";

    // ë‚´ìš© ì ìš©
    el1.textContent = labelText(saving1Data, s1);
    el2.textContent = labelText(saving2Data, s2);

    // ìƒ‰ìƒ ì ìš©
    // colorize(el1, s1.rate);
    // colorize(el2, s2.rate);

    // 6) ì£¼ì‹ ê°’ ì¶œë ¥
    const stockSellEl = document.getElementById("stock-sell-value");
    const stockBuyEl = document.getElementById("stock-buy-value");

    if (totalStockValue > 0) {
        stockSellEl.style.color = "#FF5252"; // ë¹¨ê°•
        stockBuyEl.style.color = "#4CAF50"; // ì´ˆë¡
    } else {
        stockSellEl.style.color = "#ffffff";
        stockBuyEl.style.color = "#ffffff";
    }

    // 7) ì´í•© ê³„ì‚°
    const total = balance + totalStockValue +
        (saving1Data?.amount || 0) +
        (saving2Data?.amount || 0);

    // ìˆ˜ìµë¥  í‘œì‹œ
    const stockRate =
        totalStockValue > 0
            ? ((totalStockValue / (balance + (saving1Data?.amount || 0) + (saving2Data?.amount || 0))) * 100).toFixed(2)
            : "0.00";

    const savingInterest = (s1.profit + s2.profit);

    document.getElementById("info-total").innerHTML =
        `ì´í•©: ${formatToUnit(total)}<br>` +
        `ìˆ˜ìµë¥  ${stockRate}% Â· ì´ì ${formatToUnit(savingInterest)}`;
}
setInterval(updateBottomPanel, 2000);

/* ===============================
   ğŸ”¥ ë°˜ë“œì‹œ í•„ìš”! â€” ë‹¨ìœ„ ë³€í™˜ í•¨ìˆ˜
=============================== */
function formatToUnit(num) {
    if (num < 1000) return num.toLocaleString();

    const units = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let tier = 0;

    while (num >= 1000) {
        num /= 1000;
        tier++;
    }

    const unit = units[(tier - 1) % 26];
    const quote = "'".repeat(Math.floor((tier - 1) / 26));

    return num.toFixed(2) + unit + quote;
}
function parseAmount(text) {
    if (typeof text === "number") return text;
    if (!text) return NaN;

    text = String(text).trim().toUpperCase();

    if (!isNaN(Number(text))) return Number(text);

    const m = text.match(/^([0-9\.]+)\s*([A-Z])(\'*)$/);
    if (!m) return NaN;

    const num = parseFloat(m[1]);
    const unit = m[2];
    const tier = m[3].length;

    const base = unit.charCodeAt(0) - 65; // A=0
    const exp = (base + 1) + (tier * 26);

    return num * (1000 ** exp);
}
function calcSavingProfit(saving) {
    if (!saving) return { profit: 0, rate: 0 };

    const principal = saving.amount;  // ì›ê¸ˆ
    const rate = saving.rate;         // %, ë˜ëŠ” ë°°ìˆ˜

    let finalAmount = principal;

    if (saving.product === "soso") {
        // ì†Œì†Œí•˜ê²Œ = % ì´ìœ¨
        finalAmount = principal * (1 + rate / 100);
    } else {
        // í•œë°© = ë°°ìˆ˜
        finalAmount = principal * rate;
    }

    const profit = finalAmount - principal;
    const profitRate = profit / principal * 100;

    return {
        profit,
        rate: profitRate
    };
}
async function updateTradeBalance() {
    const r = await fetch(`/api/balance?id=${USER_ID}`);
    const data = await r.json();
    document.getElementById("trade-balance").textContent =
        `ì”ì•¡: ${formatToUnit(data.balance)}`;
}

/* ===============================
   ğŸ“Œ ì´ë™í‰ê·  ê³„ì‚° í•¨ìˆ˜
=============================== */
function calcMA(candles, period) {
    if (candles.length < period) return [];

    const ma = [];
    for (let i = period - 1; i < candles.length; i++) {
        let sum = 0;
        for (let j = i - period + 1; j <= i; j++) {
            sum += candles[j].close;
        }
        ma.push(sum / period);
    }
    return ma;
}
/* ============================================================
   ğŸ¾ í« ì‹œìŠ¤í…œ - 2ë‹¨ê³„: ì• ë‹ˆë©”ì´ì…˜ & ìƒíƒœ ì—”ì§„
   (UI ìˆ˜ì • ì—†ìŒ, ê¸°ì¡´ ë¡œì§ ì˜í–¥ ì—†ìŒ)
============================================================ */

const PET = {
    type: "cat",          // í˜„ì¬ í« ì¢…ë¥˜ (ì§€ê¸ˆì€ ê³ ì–‘ì´)
    state: "idle",        // idle / happy / angry / sleep / etc
    frame: 0,
    frames: [],
    frameDelay: 120,      // í”„ë ˆì„ ì†ë„(ë°€ë¦¬ì„¸ì»¨ë“œ)
    lastFrameTime: 0,
};

/* -------------------------------------------
   ğŸ“Œ ìƒíƒœë³„ í´ë” ê²½ë¡œ ìë™ ìƒì„±
------------------------------------------- */
function getPetFolder(state) {
    return `/assets/pets/${PET.type}/${state}`;
}

/* -------------------------------------------
   ğŸ“Œ í´ë”ì— ìˆëŠ” PNG í”„ë ˆì„ ìë™ ë¡œë“œ
   â€» íŒŒì¼ ì´ë¦„ì€ 01.png ~ 20.png í˜•ì‹ì´ë©´ ëª¨ë‘ ìë™ ê°ì§€ë¨
------------------------------------------- */
async function loadPetFrames(state) {
    const folder = getPetFolder(state);

    const possible = [];
    for (let i = 1; i <= 40; i++) {
        const num = String(i).padStart(2, "0");
        possible.push(`${folder}/${num}.png`);
    }

    const result = [];

    for (const url of possible) {
        const ok = await checkImageExists(url);
        if (ok) result.push(url);
    }

    return result;
}

/* ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ */
function checkImageExists(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.src = url;
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
    });
}

/* -------------------------------------------
   ğŸ“Œ í« ìƒíƒœ ë³€ê²½ (idle â†’ happy ë“±)
------------------------------------------- */
async function setPetState(newState) {
    PET.state = newState;
    PET.frame = 0;

    const frames = await loadPetFrames(newState);

    if (frames.length === 0) {
        console.warn("âš ï¸ í”„ë ˆì„ ì—†ìŒ:", newState);
        return;
    }

    PET.frames = frames;
}

/* -------------------------------------------
   ğŸ“Œ ì• ë‹ˆë©”ì´ì…˜ ë§¤ í”„ë ˆì„ ê°±ì‹ 
------------------------------------------- */
function updatePetAnimation(timestamp) {
    const img = document.getElementById("pet-sprite");
    if (!img) return;

    if (PET.frames.length > 0) {
        if (timestamp - PET.lastFrameTime > PET.frameDelay) {
            PET.lastFrameTime = timestamp;
            PET.frame = (PET.frame + 1) % PET.frames.length;

            img.src = PET.frames[PET.frame];
        }
    }

    requestAnimationFrame(updatePetAnimation);
}

/* -------------------------------------------
   ğŸ“Œ ì´ˆê¸° ì‹¤í–‰
------------------------------------------- */
async function initPet() {
    await setPetState("idle");  // ê¸°ë³¸ idle ìƒíƒœ
    requestAnimationFrame(updatePetAnimation);
}

/* ê²Œì„ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰ */
window.addEventListener("load", initPet);

const pet = document.getElementById("pet");

let frame = 0;
const totalFrames = 10;

setInterval(() => {
    const frameWidth = pet.clientWidth;  // â† í˜„ì¬ í‘œì‹œë˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ í­ìœ¼ë¡œ ìë™ ê³„ì‚°
    pet.style.backgroundPosition = `-${frame * frameWidth}px 0px`;
    frame = (frame + 1) % totalFrames;
}, 120);

/* ===============================
   ğŸ± ê³ ì–‘ì´ í‘œì‹œ/ìˆ¨ê¹€ ì¤‘ì•™ê´€ë¦¬
=============================== */
function showPet() {
    // ğŸ“Œ ì£¼ì‹ì°½ì´ ì—´ë ¤ ìˆìœ¼ë©´ ê³ ì–‘ì´ ìˆ¨ê¹€ ìœ ì§€
    const stockUI = document.getElementById("stock-ui");
    if (stockUI && stockUI.style.display !== "none") return;

    // ğŸ“Œ ë°© ìŠ¤í‚¨ ìƒì ì´ ì—´ë ¤ ìˆìœ¼ë©´ ê³ ì–‘ì´ ìˆ¨ê¹€ ìœ ì§€
    const roomShop = document.getElementById("room-shop");
    if (roomShop && roomShop.style.display !== "none") return;

    // ğŸ“Œ ì •ìƒì ìœ¼ë¡œ í‘œì‹œ
    const pet = document.getElementById("pet-container");
    if (pet) pet.style.display = "block";
}
function hidePet() {
    const pet = document.getElementById("pet-container");
    if (pet) pet.style.display = "none";
}
/* ===============================
   ğŸ  ë°© ìŠ¤í‚¨ ì‹œìŠ¤í…œ
=============================== */
function openRoomShop() {
    renderRoomShopUI();
    const shop = document.getElementById("room-shop");
    shop.style.display = "flex"; // popup-screen ê¸°ë³¸ display:block ë¬´ì‹œ
    hidePet();
}

// ë°© ìŠ¤í‚¨ ëª©ë¡
const roomSkins = [
    { id: "Room1", price: 0 },
    { id: "Room2", price: 10 },
    { id: "Room3", price: 20 },
    { id: "Room4", price: 40 },
    { id: "Room5", price: 70 },
    { id: "Room6", price: 90 },
    { id: "Room7", price: 110 },
    { id: "Room8", price: 150 },
    { id: "Room9", price: 200 },
    { id: "Room10", price: 225 },
    { id: "Room11", price: 260 },
    { id: "Room12", price: 290 },
    { id: "Room13", price: 315 },
    { id: "Room14", price: 340 },
    { id: "Room15", price: 400 },
];

// ìƒì  ì—´ê¸°
function loadRoomShopItems() {
    const container = document.getElementById("room-shop-items");
    container.innerHTML = "";

    roomSkins.forEach(skin => {
        let btnText = "";
        let disabled = false;

        if (skin.id === currentRoomSkin) {
            btnText = "âœ” ì ìš©ë¨";
            disabled = true;
        }
        else if (ownedRoomSkins.includes(skin.id)) {
            btnText = "ì ìš©í•˜ê¸°";
        }
        else {
            btnText = `${skin.price}C êµ¬ë§¤`;
        }

        container.innerHTML += `
            <div class="shop-item">
                <img src="/assets/rooms/${skin.id}.png" alt="${skin.id}">
                <div class="shop-name">${skin.id}</div>
                <button onclick="selectRoom('${skin.id}', ${skin.price})"
                    ${disabled ? "disabled" : ""}>
                    ${btnText}
                </button>
            </div>
        `;
    });
}

// êµ¬ë§¤ ë˜ëŠ” ì„ íƒ ì´ë²¤íŠ¸ (ì¼ë‹¨ ì•Œë¦¼ìœ¼ë¡œë§Œ êµ¬í˜„)
async function selectRoom(id, price) {
     price = Number(price);
    // ì´ë¯¸ ë³´ìœ í•œ ê²½ìš°
    if (ownedRoomSkins.includes(id)) {
        applyRoomSkin(id);
        renderRoomShopUI();
        return;
    }

    const balanceRes = await fetch(`/api/balance?id=${USER_ID}`);
    const balanceData = await balanceRes.json();
    const C = balanceData.balance || 0;

    if (C < price) {
        alert("âŒ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        return;
    }

    // ì„œë²„ë¡œ êµ¬ë§¤ ìš”ì²­
    const res = await fetch("/api/buyRoomSkin", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: USER_ID, skin: id, price })
    });

    const data = await res.json();

    if (data.error) {
        alert(data.error);
        return;
    }

    ownedRoomSkins.push(id);

    applyRoomSkin(id);
    renderRoomShopUI();
    refreshBalance();

    showToast(`ğŸ‰ ${id} ìŠ¤í‚¨ êµ¬ë§¤ ì™„ë£Œ!`);
}

let currentRoomSkin = "Room1";
let ownedRoomSkins = ["Room1"]; // ê¸°ë³¸ ê°’

async function loadRoomData() {
    const r = await fetch(`/api/rooms?id=${USER_ID}`);
    const data = await r.json();

    if (data.error) return;

    ownedRoomSkins = data.ownedRooms;
    currentRoomSkin = data.currentRoom;

    applyRoomSkin(currentRoomSkin);
}

// â­ ë°°ê²½ ì ìš©
function applyRoomSkin(id) {
    currentRoomSkin = id;
    localStorage.setItem("roomSkin", id);

    document.getElementById("game-container").style.backgroundImage =
        `url('/assets/rooms/${id}.png')`;

    renderRoomShopUI();
}
// â­ ìƒì  UI ì—…ë°ì´íŠ¸
window.addEventListener("load", () => {
    applyRoomSkin(currentRoomSkin);
});

// ìƒì  UI ë Œë”ë§    
function openMyRooms() {
    const list = document.getElementById("my-room-list");
    list.innerHTML = "";

    ownedRoomSkins.forEach(id => {
        const applied = (id === currentRoomSkin);

        list.innerHTML += `
            <div class="my-room-card">
                <img src="/assets/rooms/${id}.png">
                <div style="margin-top:6px; font-size:16px; font-weight:bold;">${id}</div>
                <button onclick="applyRoomSkin('${id}')" 
                    style="background:${applied ? '#4caf50' : '#ffc533'}">
                    ${applied ? "âœ” ì ìš©ë¨" : "ì ìš©í•˜ê¸°"}
                </button>
            </div>
        `;
    });

    openPopup("my-rooms");
}

fetch(`/api/balance?id=${USER_ID}`)

function renderRoomShopUI() {
    loadRoomShopItems(); // ë‹¤ì‹œ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë ¤ UI ì—…ë°ì´íŠ¸
}
/* ===============================
   ğŸ† í¬ë””ì›€ ë­í‚¹ ë°ì´í„° ë Œë”ë§
=============================== */
function renderPodiumRanking(ranking) {
    const items = document.querySelectorAll(".podium-item");

    const first  = items[1];
    const second = items[0];
    const third  = items[2];

    const podium = [first, second, third];

    podium.forEach((elem, index) => {
        const data = ranking[index];

        if (data) {
            elem.querySelector(".name").textContent = data.name;
            elem.querySelector(".coin").textContent = formatToUnit(data.total);
        }
    });

    // 4ë“± ì´í›„
    const list = document.getElementById("podium-list");
    list.innerHTML = "";
    ranking.slice(3).forEach((user, i) => {
        list.innerHTML += `
            <div class="item">
                <span>${i+4}ìœ„ Â· ${user.name}</span>
                <span>${formatToUnit(user.total)}</span>
            </div>
        `;
    });
}
/* ===============================
   ğŸ† í¬ë””ì›€ ë­í‚¹ ì‹œìŠ¤í…œ
=============================== */    
function closePodium() {
    document.getElementById("podium-ranking").style.display = "none";
    showPet();
}
</script>
</body>
</html>